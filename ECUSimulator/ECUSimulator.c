#include <stdlib.h>
#include <stdio.h>
#include "lib/CAN/CAN_DEV_Config.h"
#include "lib/CAN/MCP2515.h"


int getMessageOnBroadcast(uint8_t *reply){
    MCP2515_ReceiveNoTimeout(0x7E8, reply);
    if(reply[0] == 0 && reply[1] == 0){
        return -1;
    }
    // printf("Received: ");
    // for(int i = 0; i < 8; i++){
    //     printf("%02X ", reply[i]);
    // }
    // printf("\n");
    return 0;
}

bool is_valid_speed(uint8_t *frame){
    uint8_t dataLen = frame[0];
    if(dataLen < 0x02){ //at least mode, pid
        printf("No data in frame.\n");
        printf("Data frame value is: %02X\n", dataLen);
        return false;
    }
    uint8_t mode = frame[1];
    if(mode == 0x01){ // a request for realtime data
        uint8_t pid = frame[2];
        //printf("PID: %02X\n", pid);
        if(pid == 0x0D){ // vehicle speed just using for test
            return true;
        }
    }
    return false;
}

int send_CAN(uint8_t *frame){
    uint32_t canID = 0x7E8; // broadcast ID
    MCP2515_Send(canID, frame, 8); // send the frame
}

int query_CAN(uint8_t num){
    // uint8_t frame[8] = {0x03, 0x01, num, 0x05,0x00, 0x00, 0x00, 0x00};// frame to send, 2 bytes, mode 1 and the PID
    // uint32_t canID = 0x7DF; // broadcast ID
    uint8_t reply[8] = {0};
    // MCP2515_Send(canID, frame, 8); // send the frame
    MCP2515_ReceiveNoTimeout(0x7E8, reply);
    if(reply[0] == 0 && reply[1] == 0){
        return -1;
    }
    // printf("Received: ");
    // for(int i = 0; i < 8; i++){
    //     printf("%02X ", reply[i]);
    // }
    // printf("\n");
}

int speedArrLen = 938;

uint8_t vehSpeedArr[] = {
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,9,11,10,13,15,17,22,24,
22,25,29,32,35,40,40,41,44,47,48,50,53,54,54,56,55,54,54,54,54,54,56,55,54,52,53,52,53,54,52,53,54,54,54,54,54,54,54,54,54,52,53,54,52,53,52,
53,52,51,51,51,53,52,51,51,51,51,49,50,51,49,50,49,48,48,48,48,48,48,50,48,50,49,48,46,45,45,43,42,42,40,39,39,39,41,40,43,44,45,47,48,46,45,
49,51,53,52,53,52,53,54,54,54,52,51,51,49,50,49,48,48,48,48,48,50,49,50,49,50,48,50,49,48,50,49,48,48,46,47,46,45,45,45,45,47,45,45,45,45,43,
42,44,43,42,42,42,44,43,44,43,44,44,45,43,44,43,44,43,44,43,44,43,42,42,42,42,40,39,39,39,39,37,38,37,36,38,37,34,35,36,34,35,34,33,34,33,33,
31,32,31,30,30,28,27,25,26,25,22,21,19,17,17,16,13,12,10,9,7,6,8,7,8,13,17,20,27,33,33,33,29,25,22,17,15,13,10,7,6,4,3,3,5,4,14,19,25,31,33,35,
36,38,37,38,37,36,36,36,36,36,31,28,25,20,16,11,7,8,7,6,8,13,15,19,21,21,24,24,28,28,31,31,32,33,35,34,35,38,37,36,38,37,39,37,38,39,39,39,39,39,
37,38,35,33,31,28,27,25,26,25,24,24,24,24,26,25,26,27,25,24,26,25,26,25,26,24,26,25,26,25,26,29,32,31,32,31,32,33,33,35,34,31,28,27,23,19,16,17,16,
15,15,17,18,16,17,18,20,23,26,29,32,35,36,36,36,38,37,38,41,40,39,41,40,39,39,39,39,41,40,41,40,41,40,39,39,39,37,36,36,36,33,31,30,30,26,24,22,19,
16,15,17,16,15,13,14,15,14,13,12,12,10,7,6,4,5,8,9,9,7,8,7,8,15,19,21,25,25,26,27,29,30,32,31,32,31,32,31,30,30,28,27,27,25,24,24,24,22,21,21,21,19,
18,20,19,20,18,18,18,16,15,13,12,10,9,7,6,6,4,3,5,4,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,5,4,
3,5,4,5,4,3,3,0,0,3,0,0,0,0,0,3,5,4,3,3,3,3,3,3,5,6,6,6,6,6,6,8,7,6,6,6,8,7,6,6,8,7,6,8,9,11,12,12,12,10,9,6,6,6,6,8,9,11,10,9,9,11,10,9,9,7,8,8,
11,8,8,7,4,5,4,3,3,3,3,3,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,5,0,0,3,0,0,0,0,5,4,5,5,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0
};

int main(void) {
    stdio_init_all();
    while(!stdio_usb_connected());
    printf("CAN OBD-II Reader Initialized\n");
    CAN_DEV_Module_Init();
    MCP2515_Init();
    uint8_t i = 0;
    absolute_time_t start = get_absolute_time();
    while(1){
        uint8_t reply[8] = {0};
        getMessageOnBroadcast(reply);
        if(is_valid_speed(reply)){
            absolute_time_t now = get_absolute_time();
            int elapsed_ms = absolute_time_diff_us(start, now) / 1000;
            int index = ((elapsed_ms / 500) +250) % speedArrLen; // array index based on 500 ms intervals
            uint8_t speed = vehSpeedArr[index];
            uint8_t speedFrame[8] = {0x04, 0x41, 0x0D, speed, 0x00, 0x00, 0x00, 0x00};
            send_CAN(speedFrame);
            printf("Sent speed: %d km/h at index %d\n", speed, index);
        }
        //query_CAN(i);
        // printf("Sent PID: %d\n", i);
        //i++;
        // sleep_ms(1000);
    }
}